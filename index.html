<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Refloria Town — 記事一覧（完全版）</title>
<meta name="description" content="Refloria Town の記事一覧。data_1012/kiji/index.json を読み込み、検索・絞り込み・テーマ切替・JSON 構文エラー箇所の表示を行います。">
<style>
  /* 基本変数（ライトをデフォルト） */
  :root{
    --bg: #ffffff;
    --card: #fbfdff;
    --text: #0b1220;
    --muted: #51606f;
    --accent: #0a84ff;
    --radius: 10px;
    --base: 16px;
    --gap: 12px;
    --mono: Menlo, Monaco, "Segoe UI Mono", "Liberation Mono", monospace;
  }

  /* ダークテーマ切替時 */
  [data-theme="dark"]{
    --bg: #0f1115;
    --card: #16181d;
    --text: #e6eef6;
    --muted: #9daab6;
    --accent: #00e5ff;
  }

  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--text);font-size:var(--base);}
  .wrap{max-width:980px;margin:28px auto;padding:18px;box-sizing:border-box;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  h1{font-size:1.25rem;margin:0}
  .small{font-size:0.9rem;color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center}
  input[type="search"], select, input[type="file"]{padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);background:transparent;color:var(--text)}
  button{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--muted);border:1px solid rgba(2,6,23,0.06)}
  .list{margin-top:18px;display:grid;gap:var(--gap)}
  .card{background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:0 1px 2px rgba(16,24,40,0.04)}
  .title{font-weight:700;margin:0 0 6px 0;font-size:1.05rem}
  .meta{font-size:0.9rem;color:var(--muted);margin-bottom:8px}
  .excerpt{color:var(--text);opacity:0.95}
  .empty{padding:18px;color:var(--muted)}
  .toolbar{display:flex;gap:6px;align-items:center}
  .fs-btn{padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer;color:var(--muted)}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(10,132,255,0.12);color:var(--accent);font-size:0.85rem}
  .split{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:16px;}
  .panel{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(2,6,23,0.04)}
  pre.json-raw{background:#0b0c0f;color:#dfe8f5;padding:12px;border-radius:8px;overflow:auto;font-family:var(--mono);font-size:13px;line-height:1.45}
  pre.json-raw.light{background:#f4f7fb;color:var(--text);}
  .error-line{background:rgba(255,100,92,0.12);display:block;padding:0 6px;border-left:3px solid rgba(255,100,92,0.14);}
  details { margin-top:8px; }
  .muted-inline{color:var(--muted);font-size:0.9rem}
  a { color: inherit; text-decoration: none; }
  .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  @media (max-width:880px){
    .split{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div>
        <h1>Refloria Town — 記事一覧（完全版）</h1>
        <div class="small">data_1012/kiji/index.json を読み込んで一覧表示します。構文エラー時は該当行を特定して表示します。</div>
      </div>

      <div class="controls" role="toolbar" aria-label="表示コントロール">
        <input id="q" type="search" placeholder="検索（タイトル / 抜粋）" aria-label="検索" />
        <select id="categoryFilter" aria-label="カテゴリで絞り込む">
          <option value="">すべてのカテゴリ</option>
        </select>
        <div class="toolbar" aria-hidden="false" style="align-items:center;">
          <button id="themeToggle" class="ghost" title="テーマ切替">ダーク</button>
          <button id="fsDown" class="fs-btn" title="フォントを小さく">小</button>
          <button id="fsUp" class="fs-btn" title="フォントを大きく">大</button>
        </div>
      </div>
    </header>

    <div class="split">
      <main>
        <div id="status" class="small" role="status" aria-live="polite">読み込み中...</div>
        <div id="list" class="list" role="list"></div>
      </main>

      <aside class="panel" aria-label="デバッグ・操作パネル">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <label class="small" for="upload-index">index.json をアップロード（上書きプレビュー）</label>
          <input id="upload-index" type="file" accept="application/json" />
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;">
          <button id="download-sample" class="ghost">サンプル index.json をダウンロード</button>
          <button id="open-raw" class="ghost">JSON 生データを表示</button>
        </div>

        <details>
          <summary class="small">構文エラー時のヒント</summary>
          <ul class="small">
            <li>「Expected ',' or '}' after property value」などはカンマが抜けている可能性を示します。</li>
            <li>余分なカンマ（末尾のカンマ）や括弧の閉じ忘れを確認してください。</li>
            <li>この UI はパースエラーの位置（行・列）を示します。行の周辺を確認してください。</li>
          </ul>
        </details>

        <div style="margin-top:12px;">
          <div class="small muted-inline">生 JSON（読み込んだもの）</div>
          <pre id="raw" class="json-raw light" aria-live="polite">未読み込み</pre>
        </div>
      </aside>
    </div>
  </div>

<script>
/*
  完全版 index.html のスクリプト
  - デフォルトで ./data_1012/kiji/index.json を fetch して表示
  - 平坦な配列フォーマットを想定: [{file,title,date,category,excerpt}, ...]
  - 構文エラー時には JSON.parse の位置情報を解析して行・列を算出し、該当行をハイライト表示
  - ファイルアップロードでローカルの index.json をプレビュー可能
  - サンプル JSON をダウンロードするボタンを提供
  - テーマ・フォントサイズ・検索・カテゴリ絞り込み
*/

(function(){
  const DEFAULT_INDEX_PATH = './data_1012/kiji/index.json';
  const SAMPLE = [
    {
      "file": "1.txt",
      "title": "Refloria Townへようこそ！",
      "date": "2025-12-14",
      "category": "ようこそ",
      "excerpt": "Refloria Town GTAロールプレイサーバーへようこそ！公式ではない案内ページです。"
    }
  ];

  const els = {
    status: document.getElementById('status'),
    list: document.getElementById('list'),
    q: document.getElementById('q'),
    categoryFilter: document.getElementById('categoryFilter'),
    themeToggle: document.getElementById('themeToggle'),
    fsDown: document.getElementById('fsDown'),
    fsUp: document.getElementById('fsUp'),
    uploadIndex: document.getElementById('upload-index'),
    raw: document.getElementById('raw'),
    downloadSample: document.getElementById('download-sample'),
    openRaw: document.getElementById('open-raw')
  };

  let data = [];
  let rawText = '';
  let currentSource = DEFAULT_INDEX_PATH;

  // helpers
  function setStatus(text, isError){
    els.status.textContent = text;
    els.status.style.color = isError ? 'var(--accent)' : '';
  }

  function downloadBlob(filename, content, mime='application/json'){
    const blob = new Blob([content], {type: mime + ';charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // position (line, column) from offset
  function offsetToLineCol(text, offset){
    const lines = text.slice(0, offset).split(/\r\n|\n|\r/);
    const line = lines.length;
    const col = lines[lines.length - 1].length + 1;
    return { line, col };
  }

  // pretty print raw and highlight a line range (startLine..endLine)
  function renderRaw(text, highlightLine){
    const lines = text.replace(/\r\n/g,'\n').split('\n');
    const el = els.raw;
    el.innerHTML = lines.map((ln, idx) => {
      const num = idx + 1;
      const safe = ln.replace(/</g,'&lt;').replace(/>/g,'&gt;');
      if (highlightLine && num >= highlightLine.start && num <= highlightLine.end) {
        return `<div class="error-line"><span class="sr-only">行 ${num}: </span><strong> ${num}</strong> ${safe}</div>`;
      } else {
        return `<div><span class="sr-only">行 ${num}: </span><span style="opacity:0.6;margin-right:8px">${num}</span> ${safe}</div>`;
      }
    }).join('');
    el.classList.toggle('light', !document.documentElement.hasAttribute('data-theme'));
  }

  function normalizeItem(p, idx){
    if (!p || typeof p !== 'object') {
      return { file: String(p || `item-${idx}`), title: String(p || ''), date:'', category:'', excerpt:'' };
    }
    return {
      file: p.file || '',
      title: p.title || p.file || '',
      date: p.date || '',
      category: p.category || '',
      excerpt: p.excerpt || ''
    };
  }

  function buildCategoryOptions(items){
    const set = new Set();
    items.forEach(i => { if (i && i.category) set.add(i.category); });
    const cats = Array.from(set).sort((a,b)=>a.localeCompare(b,'ja'));
    els.categoryFilter.innerHTML = '<option value="">すべてのカテゴリ</option>';
    cats.forEach(c => {
      const o = document.createElement('option');
      o.value = c; o.textContent = c;
      els.categoryFilter.appendChild(o);
    });
  }

  function renderList(items){
    els.list.innerHTML = '';
    if (!items.length){
      els.list.innerHTML = '<div class="empty">該当する記事がありません。</div>';
      return;
    }
    const frag = document.createDocumentFragment();
    items.forEach(it => {
      const card = document.createElement('article');
      card.className = 'card';
      card.setAttribute('role','listitem');

      const title = document.createElement('h2');
      title.className = 'title';
      const a = document.createElement('a');
      a.href = it.file || '#';
      a.textContent = it.title || it.file || '(無題)';
      a.rel = 'noopener';
      title.appendChild(a);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${it.category || 'カテゴリなし'} ・ ${it.date || ''}`;

      const excerpt = document.createElement('div');
      excerpt.className = 'excerpt';
      excerpt.textContent = it.excerpt || '';

      card.appendChild(title);
      card.appendChild(meta);
      if (excerpt.textContent) card.appendChild(excerpt);
      frag.appendChild(card);
    });
    els.list.appendChild(frag);
  }

  function applyFilters(){
    const q = (els.q.value || '').trim().toLowerCase();
    const cat = els.categoryFilter.value;
    const filtered = data.filter(i => {
      if (!i) return false;
      if (cat && i.category !== cat) return false;
      if (!q) return true;
      const hay = ((i.title||'') + ' ' + (i.excerpt||'') + ' ' + (i.file||'')).toLowerCase();
      return hay.indexOf(q) !== -1;
    });
    renderList(filtered);
    setStatus(`表示中: ${filtered.length} / ${data.length}`);
  }

  // Attempt to parse JSON and show helpful errors
  function parseIndexJson(text){
    try {
      const parsed = JSON.parse(text);
      if (!Array.isArray(parsed)) {
        throw new Error('index.json は配列である必要があります（例: [ {file,title,date,category,excerpt}, ... ]）');
      }
      return { parsed };
    } catch (e) {
      // try to extract position if present (e.g. "in JSON at position 157")
      const msg = e && e.message ? e.message : String(e);
      let position = null;
      const m = msg.match(/at position (\d+)/i);
      if (m) position = Number(m[1]);
      // Some engines (Firefox) report "JSON.parse: expected '}'" but without position.
      return { error: e, position, message: msg };
    }
  }

  // Load index.json from path (or from given text)
  async function loadIndexFromPath(path){
    currentSource = path || DEFAULT_INDEX_PATH;
    try {
      setStatus('読み込み中...');
      const res = await fetch(currentSource, {cache:'no-store'});
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      rawText = await res.text();
      els.raw.textContent = ''; // clear until renderRaw called
      const result = parseIndexJson(rawText);
      if (result.parsed) {
        data = result.parsed.map(normalizeItem);
        buildCategoryOptions(data);
        renderRaw(rawText); // show raw without highlights
        applyFilters();
        setStatus(`読み込み完了: ${data.length} 件`);
      } else {
        // show parse error with line/col if possible
        let highlight = null;
        if (result.position !== null) {
          const pos = result.position;
          const lc = offsetToLineCol(rawText, pos);
          highlight = { start: Math.max(1, lc.line-2), end: Math.min(rawText.split(/\r\n|\n|\r/).length, lc.line+2) };
          setStatus(`構文エラー: 位置 ${pos} （行 ${lc.line} 列 ${lc.col}）。カンマや括弧の位置を確認してください。`, true);
        } else {
          setStatus('JSON の解析に失敗しました（構文エラーの可能性）。カンマや括弧を確認してください。', true);
        }
        renderRaw(rawText, highlight);
        console.error('JSON parse error:', result.error || result.message);
      }
    } catch (e) {
      setStatus('読み込みに失敗しました: ' + e.message, true);
      els.raw.textContent = '読み込みできませんでした: ' + e.message;
      els.list.innerHTML = '';
      console.error(e);
    }
  }

  // Load from uploaded file
  els.uploadIndex.addEventListener('change', (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      rawText = typeof reader.result === 'string' ? reader.result : '';
      const result = parseIndexJson(rawText);
      if (result.parsed) {
        data = result.parsed.map(normalizeItem);
        buildCategoryOptions(data);
        renderRaw(rawText);
        applyFilters();
        setStatus(`アップロード読み込み完了: ${data.length} 件`);
      } else {
        let highlight = null;
        if (result.position !== null) {
          const lc = offsetToLineCol(rawText, result.position);
          highlight = { start: Math.max(1, lc.line-2), end: Math.min(rawText.split(/\r\n|\n|\r/).length, lc.line+2) };
          setStatus(`構文エラー: 位置 ${result.position} （行 ${lc.line} 列 ${lc.col}）。カンマや括弧の位置を確認してください。`, true);
        } else {
          setStatus('アップロードした JSON の解析に失敗しました（構文エラー）。', true);
        }
        renderRaw(rawText, highlight);
        console.error('Upload JSON parse error:', result.error || result.message);
      }
      // clear input so same file can be reselected later
      els.uploadIndex.value = '';
    };
    reader.onerror = () => {
      setStatus('ファイルの読み取り中にエラーが発生しました。', true);
      els.uploadIndex.value = '';
    };
    reader.readAsText(f, 'utf-8');
  });

  // Show raw JSON panel (toggle)
  els.openRaw.addEventListener('click', () => {
    const r = els.raw;
    if (r.style.display === 'none' || r.style.display === '') {
      r.style.display = 'block';
      els.openRaw.textContent = 'JSON 生データを隠す';
    } else {
      r.style.display = 'none';
      els.openRaw.textContent = 'JSON 生データを表示';
    }
  });

  // Download sample index.json
  els.downloadSample.addEventListener('click', () => {
    downloadBlob('index.sample.json', JSON.stringify(SAMPLE, null, 2));
  });

  // Bind search & filter
  els.q.addEventListener('input', debounce(applyFilters, 180));
  els.categoryFilter.addEventListener('change', applyFilters);

  // Theme toggle
  els.themeToggle.addEventListener('click', () => {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
      document.documentElement.removeAttribute('data-theme');
      els.themeToggle.textContent = 'ダーク';
      localStorage.setItem('refloria_theme','light');
    } else {
      document.documentElement.setAttribute('data-theme','dark');
      els.themeToggle.textContent = 'ライト';
      localStorage.setItem('refloria_theme','dark');
    }
    // update raw pre class for readability
    renderRaw(rawText || JSON.stringify(SAMPLE, null, 2));
  });

  // Font control
  els.fsDown.addEventListener('click', () => adjustBaseFont(-1));
  els.fsUp.addEventListener('click', () => adjustBaseFont(1));

  function adjustBaseFont(delta){
    const s = getComputedStyle(document.documentElement).getPropertyValue('--base').trim();
    const n = parseFloat(s) || 16;
    const next = Math.max(12, Math.min(24, n + delta));
    document.documentElement.style.setProperty('--base', next + 'px');
    localStorage.setItem('refloria_base', next + 'px');
  }

  // restore preferences
  (function restorePrefs(){
    const theme = localStorage.getItem('refloria_theme');
    if (theme === 'dark') {
      document.documentElement.setAttribute('data-theme','dark');
      els.themeToggle.textContent = 'ライト';
    } else {
      els.themeToggle.textContent = 'ダーク';
    }
    const base = localStorage.getItem('refloria_base');
    if (base) document.documentElement.style.setProperty('--base', base);
  })();

  // initial load
  loadIndexFromPath(DEFAULT_INDEX_PATH);

  // small helpers
  function debounce(fn, wait){
    let t;
    return function(...args){
      clearTimeout(t);
      t = setTimeout(()=>fn.apply(this,args), wait);
    };
  }

})();
</script>
</body>
</html>
