<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refloria Town Wiki</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0f1115;
            --sidebar-bg: #16181d;
            --surface-color: #1e1e1e;
            --surface-hover: #26292e;
            --primary-accent: #00e5ff;
            --secondary-accent: #b388ff;
            --text-primary: #e0e0e0;
            --text-secondary: #9daab6;
            --border-color: #2d313a;
            --danger-color: #ff5252;
            
            --sidebar-width: 280px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar (Navigation) --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .brand-area {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .brand-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(90deg, #fff, var(--primary-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-scroller {
            overflow-y: auto;
            flex: 1;
            padding: 1rem 0;
        }
        
        .nav-scroller::-webkit-scrollbar,
        .content-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .nav-scroller::-webkit-scrollbar-thumb,
        .content-scroll::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .nav-category {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-top: 1rem;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: block;
            padding: 0.6rem 1.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #fff;
        }
        .nav-item.active {
            background-color: rgba(0, 229, 255, 0.1);
            color: var(--primary-accent);
            border-left-color: var(--primary-accent);
        }

        /* --- Main Content Area --- */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .mobile-header {
            display: none;
            height: var(--header-height);
            background: var(--sidebar-bg);
            align-items: center;
            padding: 0 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .menu-btn {
            background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;
        }

        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        /* --- Home View (Cards) --- */
        .home-container {
            padding: 4rem 4rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .hero-section {
            text-align: left;
            margin-bottom: 3rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 2rem;
        }
        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        .hero-desc {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .category-group {
            margin-bottom: 3rem;
        }
        .category-title {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .category-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
            margin-left: 1rem;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-accent);
            background-color: var(--surface-hover);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        /* „ÅäÁü•„Çâ„Åõ„Ç´„Éº„ÉâÁî®„ÅÆÁâπÂà•„Çπ„Çø„Ç§„É´ */
        .card.announce-card {
            border-left: 3px solid var(--secondary-accent);
        }
        .card.announce-card .card-icon {
            color: var(--secondary-accent);
        }

        .card-icon {
            margin-bottom: 1rem;
            color: var(--primary-accent);
            font-size: 1.5rem;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .card-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .arrow-icon {
            opacity: 0;
            transform: translateX(-10px);
            transition: 0.2s;
            color: var(--primary-accent);
        }
        .card:hover .arrow-icon {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- Article View --- */
        .article-container {
            padding: 3rem 4rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .doc-header { margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .doc-title { font-size: 2.2rem; font-weight: 700; margin-bottom: 0.5rem; color: #fff; }
        .doc-meta { color: var(--text-secondary); font-size: 0.85rem; font-family: monospace; }
        
        .doc-body { line-height: 1.8; font-size: 1rem; }
        
        /* Áã¨Ëá™Ë®òÊ≥ï & ÁîªÂÉè„Çπ„Çø„Ç§„É´ */
        .embedded-img { max-width: 100%; height: auto; border-radius: 8px; margin: 1.5rem 0; border: 1px solid var(--border-color); display: block; }
        
        .custom-heading { font-size: 1.5rem; color: #fff; margin: 2.5rem 0 1rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--border-color); }
        .emphasis-block { border-left: 4px solid var(--secondary-accent); background: rgba(179, 136, 255, 0.1); padding: 1rem; margin: 1rem 0; border-radius: 0 4px 4px 0; }
        .center-text { text-align: center; display: block; margin: 1.5rem 0; }
        .marker { background: rgba(0, 229, 255, 0.2); color: var(--primary-accent); padding: 0 4px; border-radius: 4px; }
        .strikethrough { text-decoration: line-through; opacity: 0.6; }
        a.txt-link { color: var(--primary-accent); text-decoration: none; border-bottom: 1px solid var(--primary-accent); }
        ul.txt-list { margin-left: 1.5rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
        p { margin-bottom: 1.2rem; }

        /* Error Box */
        .error-box { background: rgba(255, 82, 82, 0.1); border: 1px solid var(--danger-color); padding: 1.5rem; border-radius: 8px; margin-top: 2rem; }
        .error-title { color: var(--danger-color); font-weight: bold; margin-bottom: 0.5rem; }
        .error-log { font-family: monospace; font-size: 0.8rem; background: rgba(0,0,0,0.3); padding: 10px; margin-top: 10px; border-radius: 4px; color: #ccc; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed; z-index: 100; height: 100%; transform: translateX(-100%);
            }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .home-container { padding: 2rem 1.5rem; }
            .article-container { padding: 2rem 1.5rem; }
            .doc-title { font-size: 1.8rem; }
            .card-grid { grid-template-columns: 1fr; }
        }

        /* Loading */
        .loader { display:flex; justify-content:center; align-items:center; height:100%; color: var(--primary-accent); min-height: 200px; }
    </style>
</head>
<body>

    <nav class="sidebar" id="sidebar">
        <div class="brand-area" onclick="App.renderHome()">
            <div class="brand-title">Refloria Town</div>
            <div style="font-size:0.7rem; color:var(--text-secondary); margin-top:4px;">UNOFFICIAL WIKI</div>
        </div>
        <div class="nav-scroller" id="nav-container">
            <!-- Nav items injected here -->
        </div>
    </nav>

    <div class="main-wrapper">
        <div class="mobile-header">
            <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
            <span style="margin-left:1rem; font-weight:bold;">Refloria Town</span>
        </div>

        <div class="content-scroll" id="scroll-container">
            <main id="main-content">
                <div class="loader">Loading...</div>
            </main>
            
            <footer style="margin:4rem auto 2rem; border-top:1px solid var(--border-color); padding-top:2rem; color:var(--text-secondary); font-size:0.8rem; text-align:center; max-width: 900px;">
                &copy; 2025 Refloria Town Unofficial Archive. <br>
                Managed via GitHub Pages.
            </footer>
        </div>
    </div>

    <div id="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:90;" onclick="toggleSidebar()"></div>

    <script>
        const CONFIG = {
            REAL_PATH: "data_1012/kiji/", 
            ANNOUNCE_PATH: "data_1010/announce.txt",
            IMG_PATH: "data_pic/",
            INDEX_FILE: "index.json"
        };

        // --- Core Logic ---

        const App = {
            data: null,
            announcements: [],

            init: async () => {
                await App.loadAllData();
            },

            loadAllData: async () => {
                try {
                    // index.json „Å® announce.txt „Çí‰∏¶Âàó„ÅßË™≠„ÅøËæº„ÇÄ
                    const [indexRes, announceRes] = await Promise.all([
                        fetch(`${CONFIG.REAL_PATH}${CONFIG.INDEX_FILE}`),
                        fetch(`${CONFIG.ANNOUNCE_PATH}`)
                    ]);

                    // 1. Ë®ò‰∫ã„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÂá¶ÁêÜ
                    if (!indexRes.ok) throw new Error(`HTTP_ERROR_INDEX_${indexRes.status}`);
                    try {
                        App.data = await indexRes.json();
                    } catch (e) {
                        throw new Error(`JSON_SYNTAX_ERROR: ${e.message}`);
                    }

                    // 2. „ÅäÁü•„Çâ„Åõ„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ (announce.txt)
                    if (announceRes.ok) {
                        const text = await announceRes.text();
                        // ÊîπË°å„ÅßÂàÜÂâ≤„Åó„ÄÅÁ©∫Ë°å„ÇíÈô§Âéª
                        const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== "");
                        
                        // Â•áÊï∞Ë°å=„Çø„Ç§„Éà„É´, ÂÅ∂Êï∞Ë°å=Êú¨Êñá „Å®„Åó„Å¶„Éö„Ç¢„É™„É≥„Ç∞
                        for (let i = 0; i < lines.length; i += 2) {
                            if (i + 1 < lines.length) {
                                App.announcements.push({
                                    title: lines[i],
                                    content: lines[i+1]
                                });
                            }
                        }
                    } else {
                        console.warn("Announce file not found or empty.");
                    }

                    App.renderSidebar(App.data);
                    App.renderHome();

                } catch (err) {
                    App.renderError("Data Load Failed", err);
                }
            },

            renderSidebar: (categories) => {
                const nav = document.getElementById('nav-container');
                let html = '';

                // Wiki„ÅÆË®ò‰∫ã
                categories.forEach((cat) => {
                    html += `<div class="nav-category">${cat.category}</div>`;
                    cat.pages.forEach((page) => {
                        html += `<a class="nav-item" data-file="${page.file}" onclick="App.loadPage('${page.file}', '${page.title}', '${page.date}')">${page.title}</a>`;
                    });
                });

                nav.innerHTML = html;
            },

            // „Éõ„Éº„É†ÁîªÈù¢Ôºà„Ç´„Éº„Éâ‰∏ÄË¶ßÔºâ
            renderHome: () => {
                const mainEl = document.getElementById('main-content');
                const scrollContainer = document.getElementById('scroll-container');
                
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                scrollContainer.scrollTop = 0;
                if (window.innerWidth <= 768) toggleSidebar(false);

                if (!App.data) return;

                let html = `
                    <div class="home-container">
                        <div class="hero-section">
                            <h1 class="hero-title">Refloria Town Wiki</h1>
                            <p class="hero-desc">Welcome to the unofficial information archive.</p>
                        </div>
                `;

                // --- „ÅäÁü•„Çâ„Åõ„Çª„ÇØ„Ç∑„Éß„É≥ (Â≠òÂú®„Åô„ÇãÂ†¥Âêà) ---
                if (App.announcements.length > 0) {
                    html += `
                        <div class="category-group">
                            <div class="category-title" style="color:var(--secondary-accent);">üì¢ Announcements</div>
                            <div class="card-grid">
                    `;
                    App.announcements.forEach((ann, index) => {
                        // index„ÇíÂºïÊï∞„Å´„Åó„Å¶ openAnnouncement „ÇíÂëº„Å∂
                        html += `
                            <div class="card announce-card" onclick="App.openAnnouncement(${index})">
                                <div class="card-icon">üîî</div>
                                <div class="card-title">${ann.title}</div>
                                <div class="card-meta">
                                    <span>Official Info</span>
                                    <span class="arrow-icon">‚Üí</span>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                }

                // --- WikiË®ò‰∫ã„Çª„ÇØ„Ç∑„Éß„É≥ ---
                App.data.forEach(cat => {
                    html += `
                        <div class="category-group">
                            <div class="category-title">${cat.category}</div>
                            <div class="card-grid">
                    `;
                    cat.pages.forEach(page => {
                        html += `
                            <div class="card" onclick="App.loadPage('${page.file}', '${page.title}', '${page.date}')">
                                <div class="card-icon">üìÑ</div>
                                <div class="card-title">${page.title}</div>
                                <div class="card-meta">
                                    <span>${page.date}</span>
                                    <span class="arrow-icon">‚Üí</span>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                });

                html += `</div>`;
                mainEl.innerHTML = html;
            },

            // ÈÄöÂ∏∏Ë®ò‰∫ã„ÅÆË™≠„ÅøËæº„Åø
            loadPage: async (fileName, title, date) => {
                const mainEl = document.getElementById('main-content');
                const scrollContainer = document.getElementById('scroll-container');
                
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('active');
                    if (el.getAttribute('data-file') === fileName) el.classList.add('active');
                });
                
                if (window.innerWidth <= 768) toggleSidebar(false);
                scrollContainer.scrollTop = 0;

                mainEl.innerHTML = '<div class="loader">Loading Document...</div>';

                try {
                    const res = await fetch(`${CONFIG.REAL_PATH}${fileName}`);
                    let content = "";
                    
                    if (res.ok) {
                        content = await res.text();
                    } else {
                        throw new Error(`FILE_NOT_FOUND: ${fileName}`);
                    }

                    const htmlContent = parseTextToHtml(content);

                    mainEl.innerHTML = `
                        <article class="article-container">
                            <header class="doc-header">
                                <h1 class="doc-title">${title}</h1>
                                <div class="doc-meta">Last Updated: ${date}</div>
                            </header>
                            <div class="doc-body">
                                ${htmlContent}
                            </div>
                        </article>
                    `;

                } catch (err) {
                    App.renderError("Content Load Failed", err);
                }
            },

            // „ÅäÁü•„Çâ„Åõ„ÅÆË©≥Á¥∞Ë°®Á§∫ („ÉÜ„Ç≠„Çπ„Éà„Éá„Éº„Çø„Åã„ÇâÁõ¥Êé•Ë°®Á§∫)
            openAnnouncement: (index) => {
                const mainEl = document.getElementById('main-content');
                const scrollContainer = document.getElementById('scroll-container');
                const ann = App.announcements[index];

                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                if (window.innerWidth <= 768) toggleSidebar(false);
                scrollContainer.scrollTop = 0;

                // Êú¨Êñá„ÇÇ„Éë„Éº„Çπ„Åô„ÇãÔºàÁîªÂÉè„Å™„Å©„ÅåÂê´„Åæ„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅÔºâ
                const htmlContent = parseTextToHtml(ann.content);

                mainEl.innerHTML = `
                    <article class="article-container">
                        <header class="doc-header">
                            <h1 class="doc-title" style="color:var(--secondary-accent);">${ann.title}</h1>
                            <div class="doc-meta">Category: Announcement</div>
                        </header>
                        <div class="doc-body">
                            ${htmlContent}
                        </div>
                    </article>
                `;
            },

            renderError: (title, err) => {
                const mainEl = document.getElementById('main-content');
                let msg = err.message;
                
                if (msg.includes('JSON_SYNTAX_ERROR')) {
                    msg = "index.json „ÅÆÊßãÊñá„Ç®„É©„Éº„Åß„Åô„ÄÇ";
                } else if (msg.includes('FILE_NOT_FOUND')) {
                    msg = "ÊåáÂÆö„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ";
                }

                mainEl.innerHTML = `
                    <div style="padding: 2rem;">
                        <div class="error-box">
                            <div class="error-title">‚ö†Ô∏è ${title}</div>
                            <p>${msg}</p>
                            <div class="error-log">${err.message}</div>
                        </div>
                    </div>
                `;
            }
        };

        // --- Helper Functions ---

        function toggleSidebar(forceState) {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            
            if (forceState === false || (forceState === undefined && sb.classList.contains('open'))) {
                sb.classList.remove('open');
                ov.style.display = 'none';
            } else {
                sb.classList.add('open');
                ov.style.display = 'block';
            }
        }

        // „ÉÜ„Ç≠„Çπ„Éà„Éë„Éº„Çµ„Éº (WikiË®òÊ≥ï + ÁîªÂÉèË®òÊ≥ï)
        function parseTextToHtml(text) {
            if (!text) return "";
            let html = text
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

            // ÁîªÂÉèÂüã„ÇÅËæº„Åø: ::pic:filename.jpg::
            // data_pic/filename.jpg „ÇíÂèÇÁÖß„Åô„Çã
            html = html.replace(/::pic:(.+?)::/g, '&lt;img src="' + CONFIG.IMG_PATH + '$1" class="embedded-img" alt="$1" loading="lazy"&gt;');

            // Áã¨Ëá™Ë®òÊ≥ï
            html = html.replace(/^\/:\/\s*(.+)$/gm, '<h2 class="custom-heading">\$1</h2>');
            html = html.replace(/^\|\s*(.+)$/gm, '<div class="emphasis-block">\$1</div>');
            html = html.replace(/^-\s*(.+)$/gm, '<ul class="txt-list"><li>\$1</li></ul>');
            html = html.replace(/->\s*(.+?)\s*<-/g, '<div class="center-text">\$1</div>');
            html = html.replace(/::(.+?)::/g, '<span class="marker">\$1</span>'); // ÁîªÂÉè„Å®Á´∂Âêà„Åó„Å™„ÅÑ„Çà„ÅÜÊ≥®ÊÑèÔºàÁîªÂÉè„ÅØpic:„ÇíÂê´„ÇÄÔºâ
            html = html.replace(/~~(.+?)~~/g, '<span class="strikethrough">\$1</span>');
            html = html.replace(/\*\*\*#([a-fA-F0-9]{3,6})\*(.+?)\*\*\*/g, '<span style="color:#\$1">\$2</span>');
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>\$1</strong>');
            html = html.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="\$2" target="_blank" class="txt-link">\$1</a>');
            html = html.replace(/\*(.+?)\*/g, '<em>\$1</em>');
            
            // ÊÆµËêΩÂá¶ÁêÜ
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            
            // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><h2/g, '<h2').replace(/<\/h2><\/p>/g, '</h2>');
            html = html.replace(/<p><div/g, '<div').replace(/<\/div><\/p>/g, '</div>');
            html = html.replace(/<p><img/g, '<img').replace(/>\s*<\/p>/g, '>');

            return html;
        }

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
