<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refloria Town Wiki</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0f1115;
            --sidebar-bg: #16181d;
            --surface-color: #1e1e1e;
            --surface-hover: #26292e; /* „Ç´„Éº„Éâ„Éõ„Éê„ÉºÁî® */
            --primary-accent: #00e5ff;
            --secondary-accent: #b388ff;
            --text-primary: #e0e0e0;
            --text-secondary: #9daab6;
            --border-color: #2d313a;
            --danger-color: #ff5252;
            
            --sidebar-width: 280px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar (Navigation) --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .brand-area {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer; /* „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´ */
        }
        .brand-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(90deg, #fff, var(--primary-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-scroller {
            overflow-y: auto;
            flex: 1;
            padding: 1rem 0;
        }
        
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        .nav-scroller::-webkit-scrollbar,
        .content-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .nav-scroller::-webkit-scrollbar-thumb,
        .content-scroll::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .nav-category {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-top: 1rem;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: block;
            padding: 0.6rem 1.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
            border-left: 3px solid transparent;
            text-decoration: none;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #fff;
        }
        .nav-item.active {
            background-color: rgba(0, 229, 255, 0.1);
            color: var(--primary-accent);
            border-left-color: var(--primary-accent);
        }

        /* --- Main Content Area --- */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .mobile-header {
            display: none;
            height: var(--header-height);
            background: var(--sidebar-bg);
            align-items: center;
            padding: 0 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .menu-btn {
            background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;
        }

        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0; /* padding„ÇíÂÜÖÈÉ®„Ç≥„É≥„ÉÜ„Éä„Å´ÁßªÂãï */
        }

        /* --- Home View (GitBook Card Style) --- */
        .home-container {
            padding: 4rem 4rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .hero-section {
            text-align: left;
            margin-bottom: 3rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 2rem;
        }
        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        .hero-desc {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .category-group {
            margin-bottom: 3rem;
        }
        .category-title {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .category-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
            margin-left: 1rem;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-accent);
            background-color: var(--surface-hover);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card-icon {
            margin-bottom: 1rem;
            color: var(--primary-accent);
            font-size: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .card-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .arrow-icon {
            opacity: 0;
            transform: translateX(-10px);
            transition: 0.2s;
            color: var(--primary-accent);
        }
        .card:hover .arrow-icon {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- Article View --- */
        .article-container {
            padding: 3rem 4rem;
            max-width: 900px;
            margin: 0 auto; /* ‰∏≠Â§ÆÂØÑ„Åõ */
        }

        .doc-header { margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .doc-title { font-size: 2.2rem; font-weight: 700; margin-bottom: 0.5rem; color: #fff; }
        .doc-meta { color: var(--text-secondary); font-size: 0.85rem; font-family: monospace; }
        
        .doc-body { line-height: 1.8; font-size: 1rem; }
        
        /* Áã¨Ëá™Ë®òÊ≥ï„Çπ„Çø„Ç§„É´ */
        .custom-heading { font-size: 1.5rem; color: #fff; margin: 2.5rem 0 1rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--border-color); }
        .emphasis-block { border-left: 4px solid var(--secondary-accent); background: rgba(179, 136, 255, 0.1); padding: 1rem; margin: 1rem 0; border-radius: 0 4px 4px 0; }
        .center-text { text-align: center; display: block; margin: 1.5rem 0; }
        .marker { background: rgba(0, 229, 255, 0.2); color: var(--primary-accent); padding: 0 4px; border-radius: 4px; }
        .strikethrough { text-decoration: line-through; opacity: 0.6; }
        a.txt-link { color: var(--primary-accent); text-decoration: none; border-bottom: 1px solid var(--primary-accent); }
        ul.txt-list { margin-left: 1.5rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
        p { margin-bottom: 1.2rem; }

        /* Error Box */
        .error-box { background: rgba(255, 82, 82, 0.1); border: 1px solid var(--danger-color); padding: 1.5rem; border-radius: 8px; margin-top: 2rem; }
        .error-title { color: var(--danger-color); font-weight: bold; margin-bottom: 0.5rem; }
        .error-log { font-family: monospace; font-size: 0.8rem; background: rgba(0,0,0,0.3); padding: 10px; margin-top: 10px; border-radius: 4px; color: #ccc; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed; z-index: 100; height: 100%; transform: translateX(-100%);
            }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .home-container { padding: 2rem 1.5rem; }
            .article-container { padding: 2rem 1.5rem; }
            .doc-title { font-size: 1.8rem; }
            .card-grid { grid-template-columns: 1fr; }
        }

        /* Loading */
        .loader { display:flex; justify-content:center; align-items:center; height:100%; color: var(--primary-accent); min-height: 200px; }
    </style>
</head>
<body>

    <nav class="sidebar" id="sidebar">
        <div class="brand-area" onclick="App.renderHome()">
            <div class="brand-title">Refloria Town</div>
            <div style="font-size:0.7rem; color:var(--text-secondary); margin-top:4px;">UNOFFICIAL WIKI</div>
        </div>
        <div class="nav-scroller" id="nav-container">
            <!-- Nav items injected here -->
        </div>
    </nav>

    <div class="main-wrapper">
        <div class="mobile-header">
            <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
            <span style="margin-left:1rem; font-weight:bold;">Refloria Town</span>
        </div>

        <div class="content-scroll" id="scroll-container">
            <main id="main-content">
                <div class="loader">Loading...</div>
            </main>
            
            <footer style="margin:4rem auto 2rem; border-top:1px solid var(--border-color); padding-top:2rem; color:var(--text-secondary); font-size:0.8rem; text-align:center; max-width: 900px;">
                &copy; 2025 Refloria Town Unofficial Archive. <br>
                Managed via GitHub Pages.
            </footer>
        </div>
    </div>

    <div id="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:90;" onclick="toggleSidebar()"></div>

    <script>
        const CONFIG = {
            REAL_PATH: "data_1012/kiji/", 
            DISPLAY_PATH: "content/kiji/", 
            INDEX_FILE: "index.json"
        };

        // --- Core Logic ---

        const App = {
            data: null,

            init: async () => {
                await App.loadIndex();
            },

            loadIndex: async () => {
                try {
                    const fetchPath = `${CONFIG.REAL_PATH}${CONFIG.INDEX_FILE}`;
                    const res = await fetch(fetchPath);
                    if (!res.ok) {
                        // clearer message for common HTTP errors
                        if (res.status === 404) throw new Error(`INDEX_NOT_FOUND: ${fetchPath} (HTTP 404)`);
                        throw new Error(`HTTP_ERROR_${res.status}: ${fetchPath}`);
                    }
                    
                    let parsed;
                    try {
                        parsed = await res.json();
                    } catch (e) {
                        throw new Error(`JSON_SYNTAX_ERROR: ${e.message}`);
                    }

                    // Validate format
                    if (!Array.isArray(parsed)) {
                        throw new Error('INDEX_FORMAT_ERROR: expected an array of categories');
                    }

                    App.data = parsed;

                    // Render
                    App.renderSidebar(App.data);
                    App.renderHome();

                } catch (err) {
                    App.renderError("Index Load Failed", err, `${CONFIG.REAL_PATH}${CONFIG.INDEX_FILE}`);
                }
            },

            renderSidebar: (categories) => {
                const nav = document.getElementById('nav-container');
                nav.innerHTML = ''; // clear

                if (!Array.isArray(categories)) {
                    // defensive: show nothing and log
                    App.renderError("Sidebar Render Failed", new Error("Categories not an array"), `${CONFIG.REAL_PATH}${CONFIG.INDEX_FILE}`);
                    return;
                }

                categories.forEach((cat) => {
                    const catEl = document.createElement('div');
                    catEl.className = 'nav-category';
                    catEl.textContent = cat && cat.category ? cat.category : 'Uncategorized';
                    nav.appendChild(catEl);

                    const pages = Array.isArray(cat.pages) ? cat.pages : [];
                    pages.forEach((page) => {
                        const a = document.createElement('a');
                        a.className = 'nav-item';
                        a.setAttribute('data-file', page && page.file ? page.file : '');
                        a.setAttribute('href', '#'); // make keyboard-focusable
                        a.setAttribute('role', 'button');
                        a.setAttribute('tabindex', '0');
                        a.textContent = page && page.title ? page.title : (page && page.file ? page.file : 'Untitled');
                        
                        // Click handler - use functions, avoid inline onclick with raw interpolation
                        a.addEventListener('click', (ev) => { ev.preventDefault(); App.loadPage(page.file, page.title, page.date); });
                        // keyboard activation
                        a.addEventListener('keydown', (ev) => {
                            if (ev.key === 'Enter' || ev.key === ' ') {
                                ev.preventDefault();
                                App.loadPage(page.file, page.title, page.date);
                            }
                        });

                        nav.appendChild(a);
                    });
                });
            },

            // „Ç´„Éº„ÉâÂûã„ÅÆ„Éõ„Éº„É†ÁîªÈù¢„ÇíË°®Á§∫„Åô„ÇãÊ©üËÉΩ (DOM„Éô„Éº„Çπ„ÅßXSSÂÆâÂÖ®„Å´ÁîüÊàê)
            renderHome: () => {
                const mainEl = document.getElementById('main-content');
                const scrollContainer = document.getElementById('scroll-container');
                
                // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíËß£Èô§
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                
                // „Çπ„ÇØ„É≠„Éº„É´„Çí„Éà„ÉÉ„Éó„Å∏
                scrollContainer.scrollTop = 0;

                // „É¢„Éê„Ç§„É´„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã
                if (window.innerWidth <= 768) {
                    const sb = document.getElementById('sidebar');
                    const ov = document.getElementById('overlay');
                    sb.classList.remove('open');
                    ov.style.display = 'none';
                }

                if (!Array.isArray(App.data)) {
                    mainEl.innerHTML = '<div class="loader">No data</div>';
                    return;
                }

                // build DOM
                const container = document.createElement('div');
                container.className = 'home-container';

                const hero = document.createElement('div');
                hero.className = 'hero-section';
                hero.innerHTML = `<h1 class="hero-title">Refloria Town Wiki</h1>
                                  <p class="hero-desc">Welcome to the unofficial information archive. Explore the documents below.</p>`;
                container.appendChild(hero);

                App.data.forEach(cat => {
                    const group = document.createElement('div');
                    group.className = 'category-group';

                    const title = document.createElement('div');
                    title.className = 'category-title';
                    title.textContent = cat && cat.category ? cat.category : 'Uncategorized';
                    group.appendChild(title);

                    const grid = document.createElement('div');
                    grid.className = 'card-grid';

                    const pages = Array.isArray(cat.pages) ? cat.pages : [];
                    pages.forEach(page => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.tabIndex = 0;
                        card.setAttribute('role', 'button');
                        card.addEventListener('click', () => App.loadPage(page.file, page.title, page.date));
                        card.addEventListener('keydown', (ev) => {
                            if (ev.key === 'Enter' || ev.key === ' ') {
                                ev.preventDefault();
                                App.loadPage(page.file, page.title, page.date);
                            }
                        });

                        const icon = document.createElement('div');
                        icon.className = 'card-icon';
                        icon.textContent = 'üìÑ';

                        const ctitle = document.createElement('div');
                        ctitle.className = 'card-title';
                        ctitle.textContent = page && page.title ? page.title : (page && page.file ? page.file : 'Untitled');

                        const meta = document.createElement('div');
                        meta.className = 'card-meta';
                        meta.innerHTML = `<span>Last updated: ${page && page.date ? page.date : '‚Äî'}</span><span class="arrow-icon">‚Üí</span>`;

                        card.appendChild(icon);
                        card.appendChild(ctitle);
                        card.appendChild(meta);
                        grid.appendChild(card);
                    });

                    group.appendChild(grid);
                    container.appendChild(group);
                });

                mainEl.innerHTML = '';
                mainEl.appendChild(container);
            },

            loadPage: async (fileName, title, date) => {
                const mainEl = document.getElementById('main-content');
                const scrollContainer = document.getElementById('scroll-container');
                
                // Active State Update (ÂÖ®nav-item„ÇíËµ∞Êüª„Åó„Å¶‰∏ÄËá¥„Åô„Çã„ÇÇ„ÅÆ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´)
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('active');
                    if (el.getAttribute('data-file') === fileName) {
                        el.classList.add('active');
                    }
                });
                
                // Mobile Sidebar Close
                if (window.innerWidth <= 768) {
                    const sb = document.getElementById('sidebar');
                    const ov = document.getElementById('overlay');
                    sb.classList.remove('open');
                    ov.style.display = 'none';
                }

                // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà
                scrollContainer.scrollTop = 0;

                mainEl.innerHTML = '<div class="loader">Loading Document...</div>';

                try {
                    if (!fileName) throw new Error('FILE_NAME_MISSING');
                    const fetchPath = `${CONFIG.REAL_PATH}${fileName}`;
                    const res = await fetch(fetchPath);
                    let content = "";
                    
                    if (res.ok) {
                        content = await res.text();
                    } else {
                        if (res.status === 404) throw new Error(`FILE_NOT_FOUND: ${fetchPath} (HTTP 404)`);
                        throw new Error(`HTTP_ERROR_${res.status}: ${fetchPath}`);
                    }

                    const htmlContent = parseTextToHtml(content);

                    mainEl.innerHTML = `
                        <article class="article-container">
                            <header class="doc-header">
                                <h1 class="doc-title">${escapeHtml(title || (fileName))}</h1>
                                <div class="doc-meta">Last Updated: ${escapeHtml(date || '‚Äî')}</div>
                            </header>
                            <div class="doc-body">
                                ${htmlContent}
                            </div>
                        </article>
                    `;

                } catch (err) {
                    App.renderError("Content Load Failed", err, `${CONFIG.REAL_PATH}${fileName || ''}`);
                }
            },

            renderError: (title, err, pathShown) => {
                const mainEl = document.getElementById('main-content');
                let msg = err && err.message ? err.message : String(err);

                // Friendly messages for known cases
                if (msg.includes('JSON_SYNTAX_ERROR')) {
                    msg = "index.json „ÅÆÊßãÊñá„Ç®„É©„Éº„Åß„Åô„ÄÇ„Ç´„É≥„Éû(,)„ÅÆ‰ΩçÁΩÆ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                } else if (msg.includes('FILE_NOT_FOUND')) {
                    msg = "ÊåáÂÆö„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ";
                } else if (msg.includes('INDEX_NOT_FOUND')) {
                    msg = "index.json „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éë„Çπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                } else if (msg.includes('INDEX_FORMAT_ERROR')) {
                    msg = "index.json „ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„ÇìÔºàÈÖçÂàó„ÇíÊúüÂæÖÔºâ„ÄÇ";
                } else if (msg.includes('FILE_NAME_MISSING')) {
                    msg = "Ë™≠„ÅøËæº„ÇÄ„Éï„Ç°„Ç§„É´Âêç„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ";
                }

                mainEl.innerHTML = `
                    <div style="padding: 2rem;">
                        <div class="error-box">
                            <div class="error-title">‚ö†Ô∏è ${escapeHtml(title)}</div>
                            <p>${escapeHtml(msg)}</p>
                            <div class="error-log">Tech Info: ${escapeHtml(err && err.message ? err.message : String(err))}<br>Fetch Path: ${escapeHtml(pathShown || CONFIG.REAL_PATH)}</div>
                        </div>
                    </div>
                `;
            }
        };

        // --- Helper Functions ---

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            const isOpen = sb.classList.contains('open');
            
            if (isOpen) {
                sb.classList.remove('open');
                ov.style.display = 'none';
            } else {
                sb.classList.add('open');
                ov.style.display = 'block';
            }
        }

        // basic HTML escaper for injected titles/meta
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // sanitize href: allow http(s), mailto, absolute/relative paths, hash
        function safeHref(url) {
            if (!url) return 'about:blank';
            const trimmed = String(url).trim();
            // allow: http(s):, mailto:, relative paths (./, ../, /), or hash #
            if (/^(https?:\/\/|mailto:|\/|\.\/|\.\.\/|#)/i.test(trimmed)) {
                return trimmed;
            }
            // disallow javascript: etc.
            return 'about:blank';
        }

        // Convert custom text format to safe HTML
        function parseTextToHtml(text) {
            if (!text) return '';
            // Escape first
            let escaped = String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            const lines = escaped.split(/\r?\n/);
            const out = [];

            // helper to process inline markers for a string
            function processInline(s) {
                if (!s) return '';
                // color: ***#rrggbb*text*** (non-greedy)
                s = s.replace(/\*\*\*#([a-fA-F0-9]{3,6})\*(.+?)\*\*\*/g, '<span style="color:#$1">$2</span>');
                // strong
                s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                // links [text](url) - sanitize href, add rel
                s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(_, t, u) {
                    const href = safeHref(u);
                    const rel = (href === u && /^https?:\/\//i.test(href)) ? ' rel="noopener noreferrer"' : '';
                    return `<a href="${href}" target="_blank"${rel} class="txt-link">${t}</a>`;
                });
                // emphasis
                s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
                // marker
                s = s.replace(/::(.+?)::/g, '<span class="marker">$1</span>');
                // strikethrough
                s = s.replace(/~~(.+?)~~/g, '<span class="strikethrough">$1</span>');
                // convert remaining single line breaks are handled outside
                return s;
            }

            for (let i = 0; i < lines.length; ) {
                const line = lines[i];

                // Heading: /:/ title
                const mHeading = line.match(/^\/:\/\s*(.+)$/);
                if (mHeading) {
                    out.push(`<h2 class="custom-heading">${processInline(mHeading[1])}</h2>`);
                    i++;
                    continue;
                }

                // Emphasis block: | text
                const mEm = line.match(/^\|\s*(.+)$/);
                if (mEm) {
                    out.push(`<div class="emphasis-block">${processInline(mEm[1])}</div>`);
                    i++;
                    continue;
                }

                // Center text: -> text <-
                const mCenter = line.match(/^->\s*(.+?)\s*<-\s*$/);
                if (mCenter) {
                    out.push(`<div class="center-text">${processInline(mCenter[1])}</div>`);
                    i++;
                    continue;
                }

                // Unordered list: lines starting with '- '
                if (line.match(/^\-\s+/)) {
                    const items = [];
                    while (i < lines.length && lines[i].match(/^\-\s+/)) {
                        items.push(lines[i].replace(/^\-\s+/, ''));
                        i++;
                    }
                    const lis = items.map(x => `<li>${processInline(x)}</li>`).join('');
                    out.push(`<ul class="txt-list">${lis}</ul>`);
                    continue;
                }

                // Blank line -> paragraph separator
                if (line.trim() === '') {
                    // add a paragraph break (empty element) to keep spacing
                    out.push('');
                    i++;
                    continue;
                }

                // Regular paragraph: collect consecutive non-blank, non-block lines
                const paraLines = [];
                while (i < lines.length && lines[i].trim() !== '' &&
                       !lines[i].match(/^\/:\/|^\||^->|^\-\s+/)) {
                    paraLines.push(lines[i]);
                    i++;
                }
                const paraText = paraLines.join(' ');
                out.push(`<p>${processInline(paraText)}</p>`);
            }

            // join, remove multiple blank outputs
            const html = out.filter((v, idx, arr) => {
                // collapse consecutive empty strings
                if (v === '' && arr[idx - 1] === '') return false;
                return true;
            }).join('\n');

            return html;
        }

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
