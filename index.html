<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refloria Town Information</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121212;
            --surface-glass: rgba(30, 30, 30, 0.75);
            --primary-accent: #00e5ff;
            --secondary-accent: #b388ff;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --danger-color: #ff5252;
            --warning-color: #ffab40;
            --font-main: 'Roboto', sans-serif;
            --radius-lg: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 229, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(179, 136, 255, 0.05) 0%, transparent 40%);
            color: var(--text-primary);
            font-family: var(--font-main);
            min-height: 100vh;
        }

        /* Syntax Styling Extended */
        .custom-heading {
            font-size: 1.4rem; color: var(--primary-accent);
            margin: 1.5rem 0 0.8rem 0; padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .emphasis-block {
            border-left: 4px solid var(--secondary-accent);
            background: rgba(255, 255, 255, 0.03);
            padding: 0.8rem 1rem; margin: 0.8rem 0;
            color: var(--text-secondary);
        }
        .center-text { text-align: center; display: block; margin: 1rem 0; }
        .marker { background: rgba(0, 229, 255, 0.2); color: #fff; padding: 0 4px; border-radius: 4px; }
        .strikethrough { text-decoration: line-through; opacity: 0.6; }
        strong { color: #fff; font-weight: 700; }
        a.txt-link { color: var(--primary-accent); text-decoration: underline; }
        ul.txt-list { margin-left: 1.5rem; margin-bottom: 1rem; color: var(--text-secondary); }
        ul.txt-list li { margin-bottom: 0.3rem; }

        /* Layout */
        .container { max-width: 1000px; margin: 0 auto; padding: 2rem 1.5rem; }
        header { text-align: center; margin-bottom: 4rem; animation: fadeIn 1s ease-out; }
        .site-title {
            font-size: 2.5rem; margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #fff 0%, var(--primary-accent) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .unofficial-badge {
            display: inline-block; padding: 4px 12px; border: 1px solid var(--danger-color);
            color: var(--danger-color); border-radius: 20px; font-size: 0.75rem; margin-bottom: 1rem;
        }

        /* Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem; }
        .card {
            background: var(--surface-glass); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-lg);
            padding: 1.5rem; transition: 0.3s; opacity: 0; transform: translateY(20px);
            display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-5px); border-color: rgba(0, 229, 255, 0.4); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 0.85rem; color: #888; }
        .card-title { font-size: 1.25rem; margin-bottom: 1rem; }
        .card-content { font-size: 0.95rem; color: #d0d0d0; line-height: 1.7; }

        /* Error & Loading */
        .loader { text-align: center; padding: 2rem; color: var(--primary-accent); animation: pulse 1.5s infinite; }
        .error-box {
            background: rgba(255, 82, 82, 0.1); border: 1px solid var(--danger-color);
            padding: 2rem; border-radius: var(--radius-lg); text-align: center; margin-top: 2rem;
        }
        .error-title { color: var(--danger-color); font-size: 1.2rem; margin-bottom: 1rem; font-weight: bold; }
        .error-detail { color: #ccc; font-family: monospace; font-size: 0.9rem; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; display: inline-block; text-align: left; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div id="status-container"></div>
            <h1 class="site-title">Refloria Town Information</h1>
            <p style="color:var(--text-secondary)">Refloria Town コミュニティのための情報アーカイブ</p>
        </header>
        <main id="app"><div class="loader">Loading Content...</div></main>
        <footer style="text-align:center; margin-top:4rem; color:var(--text-secondary); font-size:0.8rem;">
            &copy; 2025 Refloria Town Unofficial Archive.
        </footer>
    </div>

    <script>
        const CONFIG = {
            SITE_STATUS: "unofficial",
            // ★重要: ここが実際の読み込み先パスです
            REAL_PATH: "data_1012/kiji/", 
            // 画面表示用の論理パス名（ユーザー向け）
            DISPLAY_PATH: "content/kiji/", 
            INDEX_FILE: "index.json"
        };

        // 拡張された独自記法パーサー
        function parseTextToHtml(text) {
            if (!text) return "";
            let html = text
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

            // 1. 見出し /:/ Text
            html = html.replace(/^\/:\/\s*(.+)$/gm, '<h3 class="custom-heading">$1</h3>');

            // 2. 強調ブロック | Text
            html = html.replace(/^\|\s*(.+)$/gm, '<div class="emphasis-block">$1</div>');

            // 3. リスト - Item (新機能)
            // 連続する行をまとめてリスト化するのは複雑なため、簡易的に各行を変換
            html = html.replace(/^-\s*(.+)$/gm, '<ul class="txt-list"><li>$1</li></ul>');

            // 4. 中央揃え -> Text <- (新機能)
            html = html.replace(/->\s*(.+?)\s*<-/g, '<div class="center-text">$1</div>');

            // 5. マーカー ::Text:: (新機能)
            html = html.replace(/::(.+?)::/g, '<span class="marker">$1</span>');

            // 6. 打ち消し線 ~~Text~~ (新機能)
            html = html.replace(/~~(.+?)~~/g, '<span class="strikethrough">$1</span>');

            // 7. 色 ***#hex*Text***
            html = html.replace(/\*\*\*#([a-fA-F0-9]{3,6})\*(.+?)\*\*\*/g, '<span style="color:#$1">$2</span>');

            // 8. 太字 **Text**
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // 9. リンク [Title](Url) (新機能)
            html = html.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" class="txt-link">$1</a>');

            // 10. 斜体 *Text*
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // 改行
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        const App = {
            init: async () => {
                if (CONFIG.SITE_STATUS === "unofficial") {
                    document.getElementById('status-container').innerHTML = 
                        `<span class="unofficial-badge">NON-OFFICIAL SITE</span>`;
                }
                await App.loadContent();
            },

            showError: (title, details, techInfo) => {
                const appEl = document.getElementById('app');
                appEl.innerHTML = `
                    <div class="error-box">
                        <div class="error-title">⚠️ ${title}</div>
                        <p style="margin-bottom:10px; color:#fff;">${details}</p>
                        <div class="error-detail">
                            Error Log:<br>${techInfo}
                        </div>
                    </div>
                `;
            },

            loadContent: async () => {
                const indexPath = `${CONFIG.REAL_PATH}${CONFIG.INDEX_FILE}`;
                
                try {
                    // 1. index.json の取得
                    const indexRes = await fetch(indexPath);
                    
                    // 404エラーなどの判定
                    if (!indexRes.ok) {
                        throw new Error(`HTTP_ERROR_${indexRes.status}`);
                    }

                    // JSONパース（構文エラー判定）
                    let indexData;
                    try {
                        indexData = await indexRes.json();
                    } catch (e) {
                        throw new Error(`JSON_SYNTAX_ERROR: ${e.message}`);
                    }

                    // 記事の読み込み処理...
                    const gridEl = document.createElement('div');
                    gridEl.className = 'grid';

                    for (const post of indexData) {
                        const contentRes = await fetch(`${CONFIG.REAL_PATH}${post.file}`);
                        let rawText = contentRes.ok ? await contentRes.text() : `Error: ${post.file} not found.`;
                        
                        const card = document.createElement('article');
                        card.className = 'card';
                        card.innerHTML = `
                            <div class="card-header">
                                <span>${post.date}</span>
                            </div>
                            <h2 class="card-title">${post.title}</h2>
                            <div class="card-content">${parseTextToHtml(rawText)}</div>
                        `;
                        gridEl.appendChild(card);
                    }

                    const appEl = document.getElementById('app');
                    appEl.innerHTML = '';
                    appEl.appendChild(gridEl);
                    App.initScrollObserver();

                } catch (error) {
                    console.error(error);
                    let msgTitle = "データ読み込みエラー";
                    let msgBody = `設定されたフォルダ（${CONFIG.DISPLAY_PATH}）からデータを取得できませんでした。`;
                    let techInfo = error.message;

                    // エラーメッセージの振り分け
                    if (error.message.includes('HTTP_ERROR_404')) {
                        msgBody = "index.json が見つかりません。パスが正しいか、ファイルが存在するか確認してください。";
                        techInfo += ` (Target: ${indexPath})`;
                    } else if (error.message.includes('JSON_SYNTAX_ERROR')) {
                        msgBody = "index.json の記述形式に間違いがあります。<br>カンマ「,」のつけ忘れや、最後の要素の余分なカンマを確認してください。";
                    }

                    App.showError(msgTitle, msgBody, techInfo);
                }
            },

            initScrollObserver: () => {
                const observer = new IntersectionObserver((entries, obs) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('fade-in-up');
                            obs.unobserve(entry.target);
                        }
                    });
                });
                document.querySelectorAll('.card').forEach(c => observer.observe(c));
            }
        };

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
